<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui" />

<title>canvas test</title>
<head>
<style>
img {width:200px;}
div {mergin:10px;}
</style>
<script src="http://libs.baidu.com/jquery/2.0.0/jquery.js"></script>
<script src="./javascripts/exif.js"></script>
<!-- <script src="http://libs.baidu.com/backbone/0.9.2/backbone.js"></script> -->
</head>  
<body bgcolor="#E6E6FA">  
	<div>
		<img id="logo" src="http://ysbcc.github.io/images/font.png" />
	</div>
	<div>
		<input type="file" id="file" />
	</div>
	<div>
        <canvas width=300 height=300 id="thecanvas" style="border: 5px #666666 solid;"></canvas>  
    </div>
	<div>
		<button id="saveImageBtn">Save Image</button>  
        <button id="downloadImageBtn">Download Image</button>  
    </div> 
	<div>
		<pre id="imgExif">
		</pre>
	</div>
	<div>
		<img src id="can2img" alt="canvas to image" />
	</div>
	
	 
</body>  
<script>  
	var $e = function (a){
		return "string"==typeof a ? document.getElementById(a) : a;
	}
	
	var canvas = $e("thecanvas");
	var ctx = canvas.getContext("2d");

	window.onload = function() {  
	
		//check 
		//if(!window.URL || !window.URL.createObjectURL){
		//	alert("not support window.URL.createObjectURL:" + window.URL);
		//}
		
		if (!window.FileReader){
			alert("not support window.FileReader!");
		}
	
		draw();  
		var saveButton = $e("saveImageBtn");  
		bindButtonEvent(saveButton, "click", saveImageInfo);  
		
		var dlButton = $e("downloadImageBtn");  
		bindButtonEvent(dlButton, "click", saveAsLocalImage);  
		
		$("#file").on("change", function(e){
			if (this.files.length){			
				
				getFileUrl(this.files[0], function(url){
					startRender(url);
				});
			}
		});
	};
	
	function startRender(url){
		var bottom = new Image(); 
		bottom.src = url;
		bottom.onload = function(){   
			
			var font = $e("logo");
			var font_height = font.naturalHeight*300/font.naturalWidth;
			var height = bottom.naturalHeight*300/bottom.naturalWidth;
			if (height > font_height){
				//height = font_height;
			}
			
			readExif(bottom, function(){
				ctx.clearRect(0,0,canvas.width,canvas.height);
				var otn = EXIF.getTag(bottom, 'Orientation') || 1; 
				
				var fixInfo = fixOrientation(otn);
				
				//设置旋转点到画布中心
				ctx.translate(canvas.width/2,canvas.height/2);
				
				//旋转画布，为了修正图片方向
				ctx.rotate(fixInfo.degree);
				
				console.log(otn + "  " + fixInfo.x + "," + fixInfo.y);
				//ctx.drawImage(bottom,0,0,300,height);
				ctx.drawImage(bottom, -canvas.width/2, -canvas.height/2, 300, height); 
				
				//再切换回来，放模板
				ctx.rotate(-fixInfo.degree);
				ctx.translate(-canvas.width/2,-canvas.height/2);
				
				ctx.drawImage($e("logo"), 0, 0, 300, font_height);
				
			});
			
		}; 
	}
	
	//调整图片方向
	function fixOrientation(otn){
		//参考 http://blog.csdn.net/ouyangtianhan/article/details/29825885
		var degree = 90 * Math.PI / 180;
		var x = -1, y = -1;
		switch(otn){
			case 1:
				degree = 0;
				break;
			case 3:
				degree *= -1;
				break;
			case 5:
				degree *= 1;
				break;
			case 6:
				degree *= 1;
				break;
			case 7:
				degree *= 1;
				break;
			case 8:
				degree *= -1;
				break;
			default:
				degree = 0;
				break;
		};
		
		return {
			degree : degree,
			x : x,
			y : y
		};
	}
	
	function readExif(img, cb){
		//参考 http://code.ciaoca.com/javascript/exif-js/
	
		EXIF.getData(img, function(){ 			
			$("#imgExif").html(EXIF.pretty(this));			
			cb();
			//
			//EXIF.getTag(this, 'Orientation'); 
		}); 
	}
	
	
	/** 
	* 从 file 域获取 本地图片 url 
	*/ 
	function getFileUrl(img, cb) { 
		var url; 
		
		/* 安卓不支持
		if (navigator.userAgent.indexOf("MSIE")>=1) { // IE 
			url = img.value; 
		} 
		else {
			url = window.URL.createObjectURL(img.files.item(0)); 
		} 
		return url; 
		*/
		
		var reader = new FileReader();
		reader.onload = function(e){
			cb(e.target.result);
		};
		reader.readAsDataURL(img);
	} 
	
		
	
	function draw(){  
		  
		ctx.fillStyle = "rgba(125, 46, 138, 0.5)";  
		ctx.fillRect(25,25,100,100);   
		ctx.fillStyle = "rgba( 0, 146, 38, 0.5)";  
		ctx.fillRect(58, 74, 125, 100);  
		ctx.fillStyle = "rgba( 0, 0, 0, 1)"; // black color  
		ctx.fillText("All I want to say is..", 50, 50);  
	}  
	  
	function bindButtonEvent(element, type, handler)  
	{  
		   if(element.addEventListener) {  
			  element.addEventListener(type, handler, false);  
		   } else {  
			  element.attachEvent('on'+type, handler);  
		   }  
	}  
	  
	function saveImageInfo ()   
	{  
		var mycanvas = $e("thecanvas");  
		var image    = mycanvas.toDataURL("image/png");  
		
		var can2img = $e("can2img");
		can2img.src=image;
		var w=window.open('about:blank','image from canvas');  
		w.document.write("<img src='"+image+"' alt='from canvas'/>");  
	}  

	function saveAsLocalImage () {  
		var myCanvas = $e("thecanvas");  
		// here is the most important part because if you dont replace you will get a DOM 18 exception.  
		// var image = myCanvas.toDataURL("image/png").replace("image/png", "image/octet-stream;Content-Disposition: attachment;filename=foobar.png");  
		var image = myCanvas.toDataURL("image/png").replace("image/png", "image/octet-stream");   
		window.location.href=image; // it will save locally  
	}  
</script>  
</html> 
