<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui" />

<title>视频图像分析&特效</title>
<head>
<style>
img {display:block;}
div {mergin:10px;}
</style>

<!-- <script src="http://libs.baidu.com/backbone/0.9.2/backbone.js"></script> -->
</head>  
<body bgcolor="#999999">  
	<h1 id="tit">视频图像分析&特效</h1>
	<div id="mod_player" style="display:none;">
		<video id="vv" controls="controls" xloop="loop" webkit-playsinline x-webkit-airplay="true" data-playing-loadingad="0" preload="none" src="/images/dance.mp4"></video>
	</div>
	
	<div>
        <canvas width=640 height=256 id="thecanvas" style="border: 5px #666666 solid;"></canvas>  
    </div>
	<div style="margin:20px">
		<button id="stop">暂停</button>
		<button id="saveImageBtn">截图</button>
		<button id="myTurn">换人</button>		        		
		<button id="reset">还原</button>
		
    </div> 
	<div style="display:none;">
	<img src="/images/myhead.png" id='ahead' />
		<canvas width=640 height=256 id="shoot"></canvas>  
	</div>
	<div id="saveImg">
	</div>
	 
</body>  
<script src="http://libs.baidu.com/jquery/2.0.0/jquery.js"></script>
<script>  
	var $e = function (a){
		return "string"==typeof a ? document.getElementById(a) : a;
	}
	
	var canvas = $e("thecanvas");
	var ctx = canvas.getContext("2d");
	var player;
	var filter = 1;
	var videoControl = true;

	//gray
	function grayscale(pixels) {
		var d = pixels.data;

		for (var i = 0; i < d.length; i += 4) {
		  var r = d[i];
		  var g = d[i + 1];
		  var b = d[i + 2];
		  d[i] = d[i + 1] = d[i + 2] = (r+g+b)/3;
		}

		return pixels;
	};
	
	//复古
	function sepia (pixels) {
		var d = pixels.data;

		for (var i = 0; i < d.length; i += 4) {
		  var r = d[i];
		  var g = d[i + 1];
		  var b = d[i + 2];
		  d[i]     = (r * 0.393)+(g * 0.769)+(b * 0.189); // red
		  d[i + 1] = (r * 0.349)+(g * 0.686)+(b * 0.168); // green
		  d[i + 2] = (r * 0.272)+(g * 0.534)+(b * 0.131); // blue
		}
		return pixels;

	};
	
	//马赛克
	function mosaic (pixels) {
		var pixelArray = pixels.data;
		var mosaic= {x:4,y:4};
		
		for(var i=0;i<pixels.height;i+=mosaic.y){
			for(var j=0;j<pixels.width;j+=mosaic.x){
		    var num=Math.random();
			var randomPixel={x:Math.floor(num*mosaic.x+i),y:Math.floor(num*mosaic.y+j)};
			
			for(var k=j;k<j+mosaic.x;k++)
				for(var l=i;l<i+mosaic.y;l++){
					pixelArray[(l*pixels.width+k)*4]=pixelArray[(randomPixel.x*pixels.width+randomPixel.y)*4];
					pixelArray[(l*pixels.width+k)*4+1]=pixelArray[(randomPixel.x*pixels.width+randomPixel.y)*4+1];
					pixelArray[(l*pixels.width+k)*4+2]=pixelArray[(randomPixel.x*pixels.width+randomPixel.y)*4+2];
					pixelArray[(l*pixels.width+k)*4+3]=pixelArray[(randomPixel.x*pixels.width+randomPixel.y)*4+3];
				}
			}
		}
		
		return pixelArray;
	};
		
	function isMatch(r,g,b){
		var matchPoint = [15,226,93];//rgb
		var absR = matchPoint[0] - r;
		var absG = matchPoint[1] - g;
		var absB = matchPoint[2] - b;
		var dis = Math.sqrt(absR*absR+absG*absG+absB*absB);
		return dis < 30;
	}
	
	function checkPosition(imageData){
		var min_x = 9999,
			min_y = 9999,
			max_x = 0,
			max_y = 0;
			
        for (var y = 0; y < imageData.height; y++) {
			if (max_y && y > (max_y + 5)){
				break;
			}
		
            for (x = 0;x < imageData.width; x++) {
				if (max_x && x > (max_x + 5)){
					break;
				}
				
				var p = (y * imageData.width + x) * 4;
				//一个像素占四个字节，即 p 为当前指针的位置   
                if (isMatch(imageData.data[p],
					imageData.data[p+1],
					imageData.data[p+2])){
					
					//match
					imageData.data[p+3]=0;
					if (x < min_x) min_x = x;
					if (y < min_y) min_y = y;
					if (x > max_x) max_x = x;
					if (y > max_y) max_y = y;
					
				}
                
                //imageData.data[p+3]=0;
            }
        }
		//return null;
		if (max_x){
			return {
				x : min_x,
				y : min_y,
				width : max_x - min_x,
				height : max_y - min_y,
				imageData: imageData,
			};
		}
        return null;
    }
	
	window.onload = function() {  
	
		if (window.location.href.indexOf("show") > 0){
			$("div").show();
		}

		var v = $e("vv");
		v.load();
		v.play();		
		
		var shoot = $e("shoot");
		var shoot_ctx = shoot.getContext("2d");
		
		var videoWidth = 640;
		var videoHeight = 256;
		
		//video事件，先触发play，再触发loadedmetadata
		
		v.addEventListener('loadedmetadata', function(){
			//console.log("loadedmetadata");
			
			//重置高宽
			videoWidth = v.videoWidth;
			videoHeight = v.videoHeight;
			canvas.width = videoWidth;
			canvas.height = videoHeight;
			shoot.width = videoWidth;
			shoot.height = videoHeight;
		});
		
		//渲染画面
		v.addEventListener('play',function() {
			var head = $e("ahead");
			var i = window.setInterval(function(){				
			
				ctx.drawImage(v, 0, 0, videoWidth, videoHeight);				
				
				if (filter == 1){
					var imageData = ctx.getImageData(0, 0, videoWidth, videoHeight);
					var re = checkPosition(imageData);			
					if (re){
						//put a head into the picture
						ctx.putImageData(re.imageData, 0, 0);
						ctx.drawImage(head, re.x, re.y, re.width, re.height);	
						//console.log(re.x + "," + re.y + "[" + re.width + "," + re.height + "]");
					}
					
				}
				
			}, 65);
			
		});
		
		//截图
		var imgCount = 0;
		
		$("#saveImageBtn").on("click", function(){
			shoot_ctx.drawImage(canvas, 0, 0, videoWidth, videoHeight);
			
			imgCount++;
			shoot_ctx.fillStyle = "rgba(0, 0, 0, 0.5)";  
			shoot_ctx.fillRect(10,10,50,50); 
			shoot_ctx.font = "40pt Calibri";
			shoot_ctx.fillStyle = "rgba( 255, 255, 255, 0.8)"; // black color  
			shoot_ctx.fillText("" + imgCount, 22, 50); 
			
			var imgData = shoot.toDataURL("image/png");  
			var img = new Image();
			img.src = imgData;
			$("#saveImg").append(img);
		});
		
		var playStatus = true;
		$("#stop").on("click", function(){
			if (playStatus){				
				this.innerHTML = "播放";
				v.pause();
				
			}
			else{
				this.innerHTML = "暂停";
				v.play();
			}
			playStatus = !playStatus;
		});
		
		$("#myTurn").on("click", function(){
			filter = 1;
		});
				
		$("#reset").on("click", function(){
			filter = 0;
		});
		
		$("#tit").dblclick(function(){
			$("div").show();
		});
		
	};
	
</script>  
</html> 
